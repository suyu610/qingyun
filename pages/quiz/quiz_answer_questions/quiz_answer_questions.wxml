<wxs module="tools" src="../../../utils/numbertofix.wxs"></wxs>
<view class="header">
  <van-row>
    <van-col span="10">
      <view class="do_num">
        <view class="done">
          <text>已做　</text>
          <view class="undone_num">{{tools.hasCompeteNum(recorder)}}</view>
        </view>
        <view class="undone">
          <text>未做　</text>
          <view class="undone_num">{{recorder.length-tools.hasCompeteNum(recorder)}}</view>
        </view>
      </view>
    </van-col>
    <van-col span="4" offset="10">
      <view style="line-height:105rpx">
        <van-dropdown-menu active-color="#28B1FC">
          <van-dropdown-item id="item" title="{{ itemTitle }}">
            <view style="background-color:white">
              <van-cell title="{{ settingTitle1 }}">
                <van-switch slot="right-icon" size="24px" style="height: 26px" checked="{{ showAnswerSwitch }}"
                  active-color="#28B1FC" bind:change="onshowAnswerSwitchChange" />
              </van-cell>
              <van-cell title="{{ settingTitle2 }}">
                <van-icon slot="right-icon" name="replay" class="custom-icon" />
              </van-cell>
              <view style="padding: 15px 16px;">
                <van-button size="small" round custom-class="answer_btn" type="default" block
                  custom-style="color: #fff;background-color: #28B1FC;">
                  确认
                </van-button>
              </view>
            </view>
          </van-dropdown-item>
        </van-dropdown-menu>
      </view>
    </van-col>
  </van-row>
</view>

<view class="container" scroll-y="{{true}}">

  <view class="remain_time" wx:if="{{test.type=='test'}}">29:19</view>
  <!-- <swiper current="{{cur_ques_index}}" bindchange="bindChangeSwiper" bindtransition="bindtransition"
    bindanimationfinish="bindanimationfinish"> -->
  <swiper current="{{cur_ques_index}}" bindchange="bindChangeSwiper">
    <block wx:for="{{ques_list}}" wx:key="id">
      <swiper-item>
        <scroll-view scroll-y="true"
          style="padding:20px;box-sizing:border-box; padding-top: 0;height:calc(100vh - 50px);    padding-bottom: 106rpx;">
          <!-- 题目部分 -->
          <view class="title">
            <view class="ques_type">{{item.type}}</view>
            <view class="ques_title"><text><text
                  wx:if="{{item.value!=null}}">({{item.value}}分)</text>{{item.title}}</text></view>
            <block wx:for="{{item.files}}" wx:key="index" wx:for-item="file">
              <view class="ques_img" wx:if="{{file.type=='img'}}" bindtap="previewImage" data-src="{{file.url}}">
                <image mode="widthFix" src="{{file.url}}"></image>
              </view>

              <view class="ques_voice" wx:if="{{file.type=='voice'}}">
                <van-slider custom-class="audio_slider" value="{{audio_progress}}"
                  bind:drag-start="ondragAudioProgStart" bind:drag-end="ondragAudioProgEnd"
                  bind:change="onChangeAudioProgress" bar-height="4px" active-color="#28b1fc" />
                <view class="progress_seconds">
                  <view class="current_audio_progress">{{tools.s_to_hs(current_audio_progress)}}</view>
                  <view class="progress_control">
                    <van-icon wx:if="{{audio_paused}}" name="play-circle-o" size="28" bindtap="togglePlay"
                      data-url="{{file.url}}" />
                    <van-icon wx:else name="pause-circle-o" size="28" bindtap="togglePlay" data-url="{{file.url}}" />
                    <van-icon name="stop-circle-o" size="28" bindtap="stopPlay" />
                  </view>
                  <view class="total_audio_progress">{{tools.s_to_hs(total_audio_progress)}}</view>
                </view>
              </view>
            </block>
          </view>

          <!-- 选项部分 -->
          <view class="options {{istransition?'transition':''}}" wx:if="{{item.type=='单选题'}}">
            <block wx:for="{{item.options}}" wx:key="index" wx:for-item="option_item">
              <van-transition name="fade-up" show="{{ !istransition }}" duration="{{ { enter: 100*index } }}">
                <view class="option" bindtap="tapSingleOption" data-index="{{index}}" data-seq="{{option_item.seq}}">
                  <view class="option_title bg-{{recorder[cur_ques_index].colors[index]}}">
                    {{tools.number2Alpha(index)}}</view>
                  <view class="option_body">{{option_item.body}}</view>
                  <view class="answer_right"
                    wx:if="{{recorder[cur_ques_index].has_done && ques_list[cur_ques_index].answer==option_item.seq}}">
                  </view>
                </view>
              </van-transition>
            </block>
          </view>

          <view class="options {{istransition?'transition':''}}" wx:if="{{item.type=='多选题'}}">
            <block wx:for="{{item.options}}" wx:key="index" wx:for-item="option_item">
              <van-transition name="fade-up" show="{{ !istransition }}" duration="{{ { enter: 100*index } }}">
                <view class="option option_multi" bindtap="tapMultiOption" data-index="{{index}}"
                  data-seq="{{option_item.seq}}">
                  <view class="option_title bg-{{recorder[cur_ques_index].colors[index]}}">{{tools.number2Alpha(index)}}
                  </view>
                  <view class="option_body">{{option_item.body}}</view>
                  <view class="answer_right"
                    wx:if="{{recorder[cur_ques_index].has_done && tools.contain(ques_list[cur_ques_index].answer,index)}}">
                  </view>
                </view>
              </van-transition>
            </block>
          </view>

          <view class="options" wx:if="{{item.type=='填空题'}}">
            <van-cell-group>
              <block wx:for="{{item.options}}" wx:key="index" wx:for-item="option_item">
                <van-field bind:change="textInputChange" data-index="{{index}}" clearable
                  label="{{'第 '+tools.increment(index)+' 空'}}" placeholder="请在此作答"
                  error="{{recorder[cur_ques_index].has_done && ques_list[cur_ques_index].answer[index]!=recorder[cur_ques_index].user_mark[index]}}"
                  right-icon="{{recorder[cur_ques_index].has_done? ques_list[cur_ques_index].answer[index]==recorder[cur_ques_index].user_mark[index]?'success':'cross' :'' }}" />
              </block>
            </van-cell-group>
          </view>

          <view class="options" wx:if="{{item.type=='简答题'}}">
            <block wx:for="{{item.options}}" wx:key="index" wx:for-item="option_item">
              <van-field clearable left-icon="bulb-o" autosize center value="{{ value }}" placeholder="请在此作答"
                border="{{ true }}" bind:change="onChange" />
            </block>
          </view>

          <view class="options" wx:if="{{item.type=='单词默写题'}}">

            <van-field clearable left-icon="bulb-o" autosize center value="{{value}}" placeholder="请在此作答"
              border="{{ true }}" />
          </view>

          <view class="confirm" wx:if="{{item.type!='单选题'}}" bindtap="tapConfirmAnswer">
            <view style="position: fixed;width:  90vw;text-align: center;bottom: 20vh;">
              <van-button disabled="{{recorder[cur_ques_index].has_done}}"
                custom-style="margin-top:20px;border-radius:20rpx" slot="button" size="normal" color="#28b1fc">
                {{recorder[cur_ques_index].has_done?'已做答':'确认答案'}}
              </van-button>
            </view>
          </view>
        </scroll-view>
      </swiper-item>
    </block>
  </swiper>

  <van-transition name="slide-right" show="{{ques_list[cur_ques_index].type=='单选题' }}">
    <view class="quick_opera">
      <block wx:for="{{ques_list[cur_ques_index].options}}" wx:key="index" wx:for-item="option_item">
        <view class="opera" bindtap="tapSingleOption" data-index="{{option_item.seq}}">
          {{tools.number2Alpha(index)}}
        </view>
      </block>
    </view>
  </van-transition>

  <van-transition name="slide-right" show="{{ques_list[cur_ques_index].type=='多选题' }}">
    <view class="quick_opera">
      <block wx:for="{{ques_list[cur_ques_index].options}}" wx:key="index" wx:for-item="option_item">
        <view class="opera" bindtap="tapMultiOption" data-index="{{index}}">
          {{tools.number2Alpha(index)}}
        </view>
      </block>
    </view>
  </van-transition>
</view>

<view class="footer">
  <van-row>
    <van-col span="8">
      <view class="all_ques" bindtap="onShowQuestionList">
        <van-icon name="apps-o" />
        <view class="all_num">{{cur_ques_index+1}} / {{ques_list.length}}</view>
      </view>
    </van-col>

    <van-col span="8">
      <view class="star" bindtap="starQuestion">
        <van-icon name="bookmark-o" wx:if="{{!ques_list[cur_ques_index].has_star}}" size="24px" />
        <van-icon name="bookmark" wx:else color="#28B1FC" size="24px" />
        <!-- <view class="star_num">{{ques_list[cur_ques_index].starNum}}</view> -->
      </view>
    </van-col>

    <van-col span="8">
      <view class="answer_btn" wx:if="{{paper.type == 'test'}}">
        交卷
      </view>

      <view class="answer_btn" wx:else bindtap="showAnswer">
        解析
      </view>
    </van-col>



  </van-row>

</view>
<!-- 题目列表 -->
<van-popup show="{{ showQuesList }}" bind:close="onCloseQuestionList" position="bottom" closeable round
  custom-style="height: 40%;">
  <van-divider contentPosition="center">题目列表</van-divider>
  <view class="ques_list">
    <van-grid column-num="6" border="{{false}}">
      <block wx:for="{{ques_list}}" wx:key="index">
        <van-grid-item use-slot bindtap="jump2QuestionIndex" data-index="{{index}}">
          <view
            class="ques_list_index_title {{recorder[index].has_done? (recorder[index].correct?'bg-blue':'bg-red'):''}} ">
            {{index+1}}</view>
        </van-grid-item>
      </block>
    </van-grid>
  </view>
</van-popup>

<!-- 解答 -->
<van-popup show="{{ showAnswerPage }}" bind:close="onCloseAnswer" position="bottom" round custom-style="height: 55%;">
  <view class="answer_page">
    <van-tabs bind:change="answerPageChanged" tab-active-class="tab-active" active="{{ answer_page_index }}"
      line-height="0" title-active-color="#27B1FF" title-inactive-color="#10101055" swipeable animated
      wx:if="{{ showAnswerPage }}">
      <van-tab title="答案">
        <view class="answer">
          <view class="answer_detail">
            <view class="body">
              答案：{{ques_list[cur_ques_index].type=='多选题'||
              ques_list[cur_ques_index].type=='单选题'?tools.number2AlphaArr(ques_list[cur_ques_index].answer):ques_list[cur_ques_index].answer}}
            </view>

            <!-- <view class="timeline" style="text-align: center;padding-top: 20rpx;color: lightgrey;">答案有误?</view> -->
          </view>

          <view class="description" wx:if="{{ques_list[cur_ques_index].defaultNote==null}}">
            <van-empty image="error" description="暂无解析" />
          </view>
          <view class="description" wx:else>
            <van-divider borderColor="transparent" textColor="lightgrey" hairline contentPosition="center">
              {{ques_list[cur_ques_index].type!='单词默写题'?'答案有误?':'解释'}}</van-divider>
            <view class="source">{{ques_list[cur_ques_index].defaultNote.source}}</view>
            <text class="body">{{ques_list[cur_ques_index].defaultNote.body}}</text>
            <view class="author" wx:if="{{ques_list[cur_ques_index].type!='单词默写题'}}">
              作者：{{ques_list[cur_ques_index].defaultNote.userName}}</view>

            <view class="info" wx:if="{{ques_list[cur_ques_index].type!='单词默写题'}}">
              <view class="flex">
                <view class="timeline">{{ques_list[cur_ques_index].defaultNote.createTime}}</view>
                <view class="eye">
                  <van-icon name="eye-o" />
                  <text>{{ques_list[cur_ques_index].defaultNote.viewCount}}</text>
                </view>
              </view>
              <van-transition name="slide-right" wx:if="{{ques_list[cur_ques_index].defaultNote.hasStar}}">
                <view class="book-blue" bindtap="starDefaultNote">
                  <van-icon name="bookmark" color="#28B1FC" />
                  <text>已收藏</text>
                </view>
              </van-transition>

              <van-transition name="slide-right" wx:if="{{!ques_list[cur_ques_index].defaultNote.hasStar}}">
                <view class="book-grey" bindtap="starDefaultNote">
                  <van-icon name="bookmark-o" color="lightgrey" />
                  <text>收藏</text>
                </view>
              </van-transition>
            </view>


          </view>
        </view>
      </van-tab>

      <van-tab title="所有笔记">
        <view class="others">
          <van-empty wx:if="{{ques_list[cur_ques_index].otherNote == null}}" description="暂无笔记" />
          <view wx:else>
            <block wx:for="{{ques_list[cur_ques_index].otherNote}}" wx:key="index" wx:for-item="item">
              <view class="comment">
                <view class="body">
                  <text class="author">{{item.userName}}:</text>
                  <view class="answer_body">
                    {{item.body}}
                  </view>
                </view>
                <view class="info">
                  <view class="flex">
                    <view class="timeline">{{item.createTime}}</view>
                    <view class="eye">
                      <van-icon name="eye-o" />
                      <text>{{item.viewCount}}</text>
                    </view>
                  </view>
                  <van-transition name="slide-right" wx:if="{{item.hasStar}}">
                    <view class="book-blue" bindtap="starOthersExplain" data-index="{{index}}">
                      <van-icon name="bookmark" color="#28B1FC" />
                      <text>已收藏</text>
                    </view>
                  </van-transition>
                  <van-transition name="slide-right" wx:if="{{!item.hasStar}}">
                    <view class="book-grey" bindtap="starOthersExplain" data-index="{{index}}">
                      <van-icon name="bookmark-o" color="lightgrey" />
                      <text>收藏</text>
                    </view>
                  </van-transition>
                </view>
              </view>
              <van-divider hairline />
            </block>
          </view>
        </view>
      </van-tab>

      <van-tab title="我的笔记">
        <view class="mine">
          <!-- user_explain -->
          <van-empty wx:if="{{ques_list[cur_ques_index].user_explain == null}}" description="暂无笔记" />
          <view wx:else>
            <van-cell-group border="{{ false }}">
              <van-field value="巴拉巴拉巴拉吧巴拉巴拉巴拉吧巴拉巴拉巴拉吧巴拉巴拉巴拉吧巴拉巴拉巴拉吧" center type="textarea" autosize left-icon="edit"
                border="{{ false }}" />
            </van-cell-group>

            <view class="info" style="padding: 10px 16px;">
              <view class="timeline">2021-8-14 15:35:21</view>
              <view class="flex">
                <view class="eye">
                  <van-icon name="eye-o" />
                  <text>14</text>
                </view>
                <view class="book-white">
                  <van-icon name="bookmark-o" />
                  <text>14</text>
                </view>
              </view>
            </view>
            <van-cell title="是否公开" border="{{ false }}">
              <van-switch checked="{{ques_list[cur_ques_index].user_explain.is_public }}" size="24px"
                bind:change="onChange" />
            </van-cell>

          </view>
        </view>
      </van-tab>
    </van-tabs>

    <view class="btns">
      <van-row gutter="4">
        <van-col span="18">
          <van-row gutter="4">
            <van-button wx:if="{{answer_page_index==0}}" custom-class="answer_btn" type="default" block
              custom-style="color:#000;background-color:#ffe9a7;" icon="good-job-o">
              有帮助
            </van-button>
            <van-button wx:if="{{answer_page_index==1}}" custom-class="answer_btn" type="default" block custom-style=""
              icon="diamond-o">
              更多笔记
            </van-button>
            <van-button wx:if="{{answer_page_index==2}}" custom-class="answer_btn" type="default" block
              bindtap="showInsertNewNotePopup" custom-style="color:#000;background-color:#ffe9a7;" icon="edit">
              {{ques_list[cur_ques_index].user_explain!=null?'修改笔记':'新增笔记'}}
            </van-button>
          </van-row>
        </van-col>
        <van-col span="6">
          <van-button type="default" block custom-class="answer_btn" bindtap="showInsertNewNotePopup"
            custom-style="color:#000;background-color:#f3ecec;" bindtap="onCloseAnswer">
            关闭 </van-button>
        </van-col>
      </van-row>
    </view>
  </view>
</van-popup>

<!-- 提醒操作 -->
<van-notify id="van-notify" />



<van-popup show="{{ showInsertNewNotePopup }}" closeable position="bottom" round custom-style="height:70%"
  bind:close="onHideInsertNewNotePopup">
  <richText style="width:100vw" id='richText' readOnly='{{readOnly}}' placeholder='{{newNotePlaceholder}}'
    formatDate='YY/MM/DD' buttonTxt='保存' bind:clearBeforeEvent='clearBeforeEvent' bind:clearSuccess='clearSuccess'
    bind:undo='undo' bind:restore='restore' bind:onEditorReady='onEditorReady' bind:bindfocus='bindfocus'
    bind:bindblur='bindblur' bind:bindinput='bindinput' bind:insertImageEvent='insertImageEvent'
    bind:getEditorContent='saveNote'></richText>
</van-popup>